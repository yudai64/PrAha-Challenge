### 課題1
- PostgreSQLを使用している場合はRLSを利用する
- MysqlにはRLSの機能がないらしいがその場合は別のパターンで実現すべき。。？
  - 他のパターンだと運用大変そうなのでPostgreSQLに移行した方がいい。。？

### 課題2
#### マルチテナントアーキテクチャの実現パターンごとのメリットデメリット
  - ***「テナント毎にデータベースを分割する」***
    - メリット
      - セキュリティ性が高い
      - テナント固有の設定がしやすい
        - スケールアップなど
    - デメリット
      - 運用が大変
      - 費用がかかる

  - ***「テナント毎にスキーマを分割する」***
    - メリット
      - テナント毎にデータベースを分割する場合に比べて費用が抑えられる
      - テナント間のデータが混ざる可能性を考慮せずにすむ
    - デメリット
      - 運用はやはり大変そう
      - テナント数が増えるにつれてマイグレーションに時間がかかる

  - ***「すべてのテナントで同じスキーマを使う」***
    - メリット
      - 運用がしやすい
      - 費用が安く済む
      - スケーラビリティが高い(?)
    - デメリット
      - 他のパターンと比較してセキュリティに気を付ける必要がある
        - 課題1の例とか

#### RLSと、これを活用したマルチテナントアーキテクチャの実装方法
  - ***RLS***
    > GRANTによって利用できるSQL標準の権限システムに加えて、通常の問い合わせでどの行が戻され、データ更新のコマンドでどの行を挿入、更新、削除できるかをユーザ単位で制限する行セキュリティポリシーをテーブルに定義できます。 
    - SQL標準のアクセス権限に加えて、テーブルの行単位でのアクセスをユーザー単位で制限できる
  - ***マルチテナントアーキテクチャの実装方法***
    - テーブル定義時
      - テーブルにテナントを識別するカラムを作成する
      - テーブルの行セキュリティを有効にする
        - `ENABLE ROW LEVEL SECURITY`
      - 行セキュリティポリシーを設定する
        - `CREATE POLICY`
    - コネクション時
      - `tenant_id`を設定する
        - `SELECT set_config('app.tenant_id', :tenantId, false);`
    - INSERT時
      - `tenant_id`に値を設定する
      - `INSERT INTO invoice (tenant_id, invoice_uuid, publisher) VALUES (current_setting('app.tenant_id'), :invoiceUUID, :publisher);`
    - SELECT, UPDATE, DELETE時
      - WHERE分は不要
        - `tenant_id = current_setting('app.tenant_id')`が暗黙的に挿入される

### 参考
- [マルチテナントSaaSのテナント分離をRow-Level Securityに移行した](https://buildersbox.corp-sansan.com/entry/2021/05/10/110000)
- [5.7. 行セキュリティポリシー](https://www.postgresql.jp/document/11/html/ddl-rowsecurity.html)
- [マルチテナント化で知っておきたいデータベースのこと](https://www.slideshare.net/AmazonWebServicesJapan/20220107-multi-tenant-database)

---
- [マルチテナントとは](https://kotobank.jp/word/%E3%83%9E%E3%83%AB%E3%83%81%E3%83%86%E3%83%8A%E3%83%B3%E3%83%88-1693419#:~:text=%E3%83%9E%E3%83%AB%E3%83%81%E3%83%86%E3%83%8A%E3%83%B3%E3%83%88%EF%BC%88multi%2Dtenant%EF%BC%89,%E4%B8%80%E8%88%AC%E7%9A%84%E3%81%AB%E3%81%AA%E3%81%A3%E3%81%9F%E3%80%82)
>SaaSサースなどのサービスにおいて、複数の顧客企業が一つのシステムを共有する方式。シングルテナントに比べ、低コストで利用できる。仮想化技術とサーバーの性能の向上によってクラウドコンピューティングが広く普及し、より一般的になった。

- [知られざる「マルチテナントアーキテクチャ」（1）～SaaSはみんな同じではない？](https://www.publickey1.jp/blog/09/1saas.html)
  - セールスフォースはすべてのユーザーが同一データベース、同一スキーマを共有している。(2009)
  - ユーザーが扱うデータは1つのデータベースに格納される
    - 厳重なセキュリティが必要
    - ある企業が他の企業のデータを参照してしまわないようにする必要がある
    - データベースに格納されるデータには「組織ID」が付けられる
    - パーティショニング機能
      - 1つのデータベースを複数に分割
      - 集計が高速になったり障害があった時に被害を最小限に抑えられる
    - パラレル機能
      - パーティションに分割したデータベースごとにDBMSのプロセス（インスタンス）を割り当てることで、
      - 巨大なデータベースを複数のプロセスで分散処理させることができる。
        - 例えば、巨大なデータベースを10台のサーバで分散して稼働させる、といったことが可能
    - データテーブルとメタテーブル
      - セールスフォースのアプリケーションで扱われる数字や文字のデータはDataテーブルに保存される
